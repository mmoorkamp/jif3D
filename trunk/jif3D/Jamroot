import feature ;

feature.feature gpu : off on : composite incidental ;
feature.compose <gpu>on : <define>HAVEGPU ; 

feature.feature gravcache : disk mem none : composite incidental propagated ;
feature.compose <gravcache>disk : <define>GRAVDISK ;
feature.compose <gravcache>mem : <define>GRAVMEM ;
feature.compose <gravcache>none : <define>GRAVCALC ; 

feature.feature magcache : disk mem none : composite incidental propagated ;
feature.compose <magcache>disk : <define>MAGDISK ;
feature.compose <magcache>mem : <define>MAGMEM ;
feature.compose <magcache>none : <define>MAGCALC ; 


feature.feature parallelization : openmp hpx  : composite propagated symmetric ;
feature.compose <parallelization>openmp : <define>HAVEOPENMP <cflags>" -fopenmp  " <linkflags>" -fopenmp  " ;
feature.compose <parallelization>hpx : <define>HAVEHPX <hpx>on <cflags>"-fopenmp `pkg-config --cflags hpx_application`" <linkflags>"-fopenmp  `pkg-config --libs hpx_application` " ;

constant BOOST_LIB_PATH : /usr/local/lib ;
constant NETCDF_LIB_PATH : /usr/local/lib ;
constant CUDA_LIB_PATH : /usr/local/cuda/lib64 ;
path-constant TOP : . ;


project 
    : requirements
    	<include>$(TOP)
        <include>/usr/local/cuda/include
        <threading>multi 
        <gpu>off
    	<variant>release:<define>NDEBUG
    	<variant>profile:<define>NDEBUG  
    	<variant>debug:<define>BOOST_TEST_TOOLS_UNDER_DEBUGGER
    	<toolset>gcc:<cxxflags>" -std=c++14  -Wall  -Wno-long-long   -pedantic"
    	<toolset>gcc:<linkflags>" -Wl,--disable-new-dtags"
    	<toolset>gcc<variant>debug:<cxxflags>" -ggdb3 -O0 "
    	<toolset>clang:<cxxflags>" -std=c++14  -Wall  -Wno-long-long   -pedantic"
    	<toolset>msvc:<define>_SCL_SECURE_NO_WARNINGS
    	<toolset>msvc:<define>NOMINMAX
		<toolset>msvc:<define>BOOST_ALL_DYN_LINK
    	<toolset>msvc:<cxxflags>" /openmp /wd4101 /wd4244 /wd4068 /wd4305 /wd4267 "
    	<toolset>intel:<cxxflags>" -qopenmp  -std=c++14 -Wall "
    	<toolset>intel:<define>TESTR
    	#<toolset>intel:<define>BOOST_NO_CXX11_SCOPED_ENUMS
    	<toolset>intel:<linkflags>" -qopenmp -std=c++14 "
    	<toolset>sun:<define>BOOST_UBLAS_UNSUPPORTED_COMPILER=0
    	<toolset>sun:<cflags>" -library=stlport4" 
    	<toolset>sun:<linkflags>" -library=stlport4" 
    ;
	
# notes on MSVC warnings:
# /wdXXXX supresses a warning with number XXXX
# 4101 = unreferenced local variable (often generated by catch blocks)
# 4244 = possible narrowing (very frequent in the legacy code)
# 4068 = unknown pragma (often refers to GCC, ideally should be changed
# 4305 = truncation from double to float (quite common, esp. Tomo/PodvinTime3D.cpp)
# 4267 = conversion from size_t to "const long", possible loss of data



import cuda ;


local BOOST_TEST_LOG_LEVEL = all ;
lib boost_filesystem : : <name>boost_filesystem <search>$(BOOST_LIB_PATH)  ;
lib boost_system : : <name>boost_system <search>$(BOOST_LIB_PATH) ;
lib boost_program_options : : <name>boost_program_options  <search>$(BOOST_LIB_PATH) ;
lib boost_mpi : : <name>boost_mpi  <search>$(BOOST_LIB_PATH) ;
lib boost_serialization : : <name>boost_serialization  <search>$(BOOST_LIB_PATH) ;
lib boost_thread : : <name>boost_thread  <search>$(BOOST_LIB_PATH) ;
lib boost_iostreams : : <name>boost_iostreams  <search>$(BOOST_LIB_PATH) ;
lib boost_date_time : : <name>boost_date_time  <search>$(BOOST_LIB_PATH) ;
lib boost_chrono : : <name>boost_chrono  <search>$(BOOST_LIB_PATH) ;
lib boost_python : : <name>boost_python  <search>$(BOOST_LIB_PATH) ;
lib boost_test : : <name>boost_unit_test_framework  <search>$(BOOST_LIB_PATH) ;
lib hpx_iostreams : : <name>hpx_iostreams ;
lib hpx : : <name>hpx ;
lib hpx_ag : : <name>hpx_ag ;
lib netcdf : : <name>netcdf <link>shared ;
lib netcdf_c++ : : <name>netcdf_c++4  <search>$(NETCDF_LIB_PATH)  ; # linux
lib Geographic : : <name>Geographic  ;
#lib netcdf_c++ : : <name>netcdf-cxx4 <link>shared ; #windows
lib gfortran : :  <name>gfortran ;
lib cudart : : <name>cudart <search>$(CUDA_LIB_PATH) ;
lib cublas : : <name>cublas <search>$(CUDA_LIB_PATH) ;
alias boost_core : boost_program_options boost_filesystem  boost_system ;

build-project Global ;
build-project Gravity ;
build-project Magnetics ;
build-project MT ;
build-project Tomo ;
build-project DataBase ;
build-project ModelBase ;
build-project Inversion ;
build-project Regularization ;
build-project Profiling ;
build-project Hacks ;
build-project Joint ;
build-project ModelTransforms ;
build-project MI ;
build-project DCResistivity ;
build-project SurfaceWaves ;
#build-project hpx_simer ;

